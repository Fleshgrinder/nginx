#! -----------------------------------------------------------------------------
# This is free and unencumbered software released into the public domain.
#
# Anyone is free to copy, modify, publish, use, compile, sell, or distribute
# this software, either in source code form or as a compiled binary, for any
# purpose, commercial or non-commercial, and by any means.
#
# In jurisdictions that recognize copyright laws, the author or authors of this
# software dedicate any and all copyright interest in the software to the public
# domain. We make this dedication for the benefit of the public at large and to
# the detriment of our heirs and successors. We intend this dedication to be an
# overt act of relinquishment in perpetuity of all present and future rights to
# this software under copyright law.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
# ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
# For more information, please refer to <http://unlicense.org>
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Main nginx configuration.
#
# AUTHOR: Richard Fussenegger <richard@fussenegger.info>
# COPYRIGHT: Copyright (c) 2014 Richard Fussenegger
# LICENSE: http://unlicense.org/ PD
# LINK: http://richard.fussenegger.info/
# ------------------------------------------------------------------------------

pcre_jit                            on;
timer_resolution                    1s;
# Six-core Xeon with Hyper-Threading.
worker_cpu_affinity
                                    000001000001000001000001000001000001
                                    000010000010000010000010000010000010
                                    000100000100000100000100000100000100
                                    001000001000001000001000001000001000
                                    010000010000010000010000010000010000
                                    100000100000100000100000100000100000
;
worker_priority                     15;
worker_processes                    6;
worker_rlimit_core                  0;
worker_rlimit_nofile                262144;

events {
    accept_mutex                    on;
    accept_mutex_delay              50ms;
    multi_accept                    on;
    worker_connections              131072;
}

http {
    access_log                      off;
    charset                         utf-8;
    client_body_timeout             3s;
    client_header_timeout           3s;
    client_max_body_size            16m;
    default_type                    application/octet-stream;
    gzip                            on;
    gzip_http_version               1.0;
    gzip_min_length                 256;
    gzip_proxied                    any;
    gzip_static                     on;
    gzip_types
                                    application/javascript
                                    application/json
                                    application/vnd.ms-fontobject
                                    application/x-font-ttf
                                    application/xml
                                    font/opentype
                                    image/svg+xml
                                    image/x-icon
                                    text/css
                                    #text/html is always compressed.
                                    text/plain
    ;
    gzip_vary                       on;
    ignore_invalid_headers          on;
    include                         includes/headers.conf;
    include                         mime.types;
    include                         sites/*.conf;
    index                           index.html index.htm;
    keepalive_disable               none;
    keepalive_requests              50;
    keepalive_timeout               120s;
    max_ranges                      0;
    msie_padding                    off;
    open_file_cache                 max=1000 inactive=2h;
    open_file_cache_errors          on;
    open_file_cache_min_uses        1;
    open_file_cache_valid           1h;
    output_buffers                  1 512;
    postpone_output                 1440;
    read_ahead                      512k;
    recursive_error_pages           on;
    reset_timedout_connection       on;
    send_timeout                    9s;
    sendfile                        on;
    sendfile_max_chunk              512k;
    server_name_in_redirect         off;
    server_names_hash_bucket_size   64;
    server_tokens                   off;
    spdy_headers_comp               5;
    spdy_keepalive_timeout          120s;
    spdy_max_concurrent_streams     100;
    spdy_recv_timeout               3s;
    ssl_buffer_size                 1400;
    ssl_ciphers                     kEECDH+ECDSA:kEECDH:kEDH:HIGH:+SHA:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!DSS:!PSK:!RC4:!kRSA:!SRP:!kECDH:!CAMELLIA;
    ssl_ecdh_curve                  prime256v1;
    ssl_prefer_server_ciphers       on;
    ssl_protocols                   TLSv1.2 TLSv1.1 TLSv1;
    ssl_session_cache               shared:SSL:100m;
    ssl_session_timeout             12h;
    tcp_nodelay                     on;
    tcp_nopush                      on;
    types_hash_max_size             2048;
    uninitialized_variable_warn     off;

    upstream php {
        least_conn;
        keepalive 3;

        server unix:/dev/shm/php-fpm-1.sock max_fails=250 fail_timeout=180s;
        server unix:/dev/shm/php-fpm-2.sock max_fails=250 fail_timeout=180s;
        server unix:/dev/shm/php-fpm-3.sock backup;
    }

    # Check for existence of the default PHP session cache limiter. If it is present
    # do not send a cached request and instead bypass any caches.
    #
    # SEE: https://php.net/session.configuration#ini.session.cache-limiter
    # SEE: https://php.net/session-cache-limiter
    map $http_cookie $nocache {
        default 0;
        nocache 1;
    }
}
